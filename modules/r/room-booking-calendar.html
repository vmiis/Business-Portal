<div id=D__ID>
    <div>
        VmInclude:__COMPONENT__/m/month.01.html
    </div>
    <script>
    function F__ID(){
        //--------------------------------------------------------
        VmInclude:__COMPONENT__/m/month.01.js
        //--------------------------------------------------------
    	m.on_day_click_fun=function(date){
    		$vm.load_module(m.booking,'',{day:date})
    	}
    	//--------------------------------------------------------
        m.request_and_render=function(){
            var mt1=new Date().getTime();
            $vm.request({cmd:"find",query:{App:m.App,Table:m.Table,I1:{"$gt":m.first_day,"$lt":m.last_day}},options:{}},function(res){
                if(res.permission==false){
                    alert("No permission to get room information.");
                    return;
                }
                //-----------------------
                var mt2=new Date().getTime();
                var tt_all=mt2-mt1;
                var tt_server=parseInt(res.sys.elapsed_time);
                if(tt_all<tt_server) tt_all=tt_server;
                $("#elapsed__ID").text((JSON.stringify(res.records).length/1000).toFixed(1)+"kb/"+tt_all.toString()+"ms/"+tt_server+'ms');
                //-----------------------
    	        m.calendar_render("");
                m.records=res.records;
    			for(var i=0;i<res.records.length;i++){
    	            m.cell_render(res.records[i]);
    			}
            });
        }
        //--------------------------------------------------------
        m.cell_render=function(record){
            var id=record._id;
            var time=record.Data.Time;
            var room=record.Data.Room_number;
            var name=record.Data.Contact_name; if(name===undefined) name="No contact name";
            var color=record.Data.Color;
            var author=record.Submitted_by;
            var d=record.Data.Date;
            var $div=m.get_cell_div(d);
            var desc="";
            if(record.Data.Description!="") desc=" <br>"+$vm.text(record.Data.Description);
    	    var info="<span  style='color:"+$vm.invert_color(color)+"'>"+room+" "+name+desc+"<br>"+time+' '+$vm.text(record.Data.Duration)+" hours </span>";
            var event="<div style='background-color:"+color+"' class=event__ID data-author="+author+" id=event__ID"+id+">"+info+"</div>";
            $div.append(event);
            $('#event__ID'+id).on('click',function(){
                $vm.load_module(m.booking_form,'',{record:record});
            });
        }
        //--------------------------------------------------------
        m.put_on_click_for_booking=function(){
            $('#tbody__ID tr').each(function(){
                var id  =$(this).children().eq(0).text();
                var uid =$(this).children().eq(1).text();
                var room_number  =$(this).children().eq(2).text();
                var room_name  =$(this).children().eq(3).text();
                var name  =$(this).children().eq(4).text();
                for(var j=0;j<24;j++){
                    var $cell=$(this).children().eq(5+j);
                    $cell.data('j',j);
                    $cell.on('click',function(){
                        var j=$(this).data('j');
                        var date=$('#date__ID').val();
                        var time=$vm.pad((8+Math.floor(j/2)),2)+":"+$vm.pad(30*(j%2),2);
                        var record={}
                        record.UID=uid,
                        record.Data={
                            Room_number:room_number,
                            Room_name:room_name,
                            Date:date,
                            Time:time,
                        }
                        $vm.load_module(m.booking_form,'',{record:record,goback:1});
                    })
                    $cell.css('cursor','pointer');
                }
            });
        };
        //--------------------------------------------------------
        var put_on_bookings=function(){
            var m1=m.booking_form;
            var table=$vm.module_list[m1].Table;
            var date=$('#date__ID').val();
            $vm.request({cmd:"find",query:{App:m.App,Table:table,I1:date},options:{}},function(res){
                if(res.permission==false){
                    alert("No permission to read room booking records.");
                    return;
                }
                //-----------------------
                for(var i=0;i<res.records.length;i++){
                    var rid			=res.records[i]._id;
                    var uid			=res.records[i].I3;
                    var contact		=res.records[i].Data.Contact_name; if(contact==='') contact='No Contact';
                    var date		=res.records[i].Data.Date; date=$vm.date_parse(date);
                    var time		=res.records[i].Data.Time;
                    var duration_0	=res.records[i].Data.Duration;
                    var color		=res.records[i].Data.Color;
                    var author		=res.records[i].Submitted_by;
                    //----------------------
                    var duration	=parseFloat(duration_0);
                    var num=duration/0.5;
                    var pos=((parseInt(time.split(':')[0])-8)*60+parseInt(time.split(':')[1]))/30;
                    var $tr=$("#tbody__ID td:nth-child(2)").filter(function() {
                        return $(this).text()==uid;
                    }).closest("tr");
                    for(var j=0;j<num;j++){
                        var $cell=$tr.find('td').eq(pos+5+j);
                        $cell.off('click');
                        $cell.css('cursor','default');
                        $cell.css('background-color',color);
                        if(j!==0 && j!==num-1){		$cell.css('border-left','0px solid red');	$cell.css('border-right','0px solid red');	}
                        else if(j===0 && num>1){	$cell.css('border-right','0px solid red');	}
                        else if(j==num-1 && num>1){	$cell.css('border-left','0px solid red');	}
                        if(j===0){
                            $cell.html('<u style=cursor:pointer>'+contact+'</u>');
                            $cell.find('u').data("rid",rid);
                            $cell.find('u').data("author",author);
                            $cell.find('u').on('click',on_click_edit_fun);
                        }
                    }
                }
            })
        };
        //-----------------------------------
        var on_click_edit_fun=function(){
            var rid=$(this).data('rid');
            var m1=m.booking_form;
            var table=$vm.module_list[m1].Table;
            var date=$('#date__ID').val();
            $vm.request({cmd:"find",query:{App:m.App,Table:table,_id:rid},options:{}},function(res){
                if(res.permission==false){
                    alert("No permission to read room booking records.");
                    return;
                }
                $vm.load_module(m.booking_form,'',{record:res.records[0],goback:1});
            })
        };
        //--------------------------------------------------------
        $('#D__ID').on('load',function(){
            m.request_and_render();
        });
        //--------------------------------------------------------
        $('#D__ID').on('show',function(){  if($vm.refresh==1){$vm.refresh=0; m.request_and_render();}    });
        //--------------------------------------------------------
    }
    </script>
    <style>
    #D__ID{
        background-color:#fff;
        font-size:13px;
        font-family: Helvetica, Arial, sans-serif;
        height:100%;
        overflow: auto;
    }
    </style>
</div>
